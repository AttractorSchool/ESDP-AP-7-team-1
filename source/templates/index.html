{% extends 'base.html' %}
{% load static %}
{% load bootstrap5 %}
{% block title %} Главная страница {% endblock %}

{% block nav %}
    <nav class="sidebar sidebar-offcanvas" id="sidebar">
        <ul class="nav">
        </ul>
    </nav>
{% endblock %}

{% block content %}
    <p class="card-title text-center">Оставьте Вашу заявку</p>
    <div class="card-body">
        <h6 class="font-weight-light">Заполните все поля и выберете интересующие Вас предметы:</h6>
        <form class="forms-sample" action="" method="post">
            {% csrf_token %}
            {% bootstrap_form form %}
            <div class="mt-3 text-center">
                <button style="background:linear-gradient(90deg, #c352eb, #8adabd)"
                        class="btn border-0 btn-primary btn-lg font-weight-medium auth-form-btn send_application_form"
                >ОСТАВИТЬ ЗАЯВКУ
                </button>
            </div>
        </form>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
            crossorigin="anonymous"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
    <script>
        $('input[type=checkbox]').on('change', function (e) {
            if ($('#sum_package')) {
                $('#sum_package').remove()
            }
            if ($('input[type=checkbox]:checked').length > 4) {
                $(this).prop('checked', false);

                $('#content').prepend(`<div class="alert alert-warning alert-dismissible fade show" role="alert"  id="id_selected_subjects">
  <strong>Можно выбрать только 4 предмета</strong>
  <button type="button" class="btn-close pb-2" data-bs-dismiss="alert" aria-label="Close"></button>
</div>`)
            setInterval(function () {
                            $(`#id_selected_subjects`).remove()
                        }, 5000);
            }
            let checked = $('input[type=checkbox]:checked').length
            console.log(checked)
            $.ajax({
                url: `/api/get_sum`,
                type: "POST",
                data: JSON.stringify({
                    'package': checked
                }),
                success: function (data) {
                    $("#id_subjects").append(`<label class="form-label" id='sum_package'>Выбран ${data.package}. Цена ${data.sum}</label>`)
                },
                error: function (data) {
                    console.log('error')
                    {#<div class="invalid-feedback">Обязательное поле.</div>#}
                }
            });
        });
    </script>
    <script>
        $('.send_application_form').on('click', function (e) {
            e.preventDefault();
            let email_ = $('#id_email').val()
            let name_ = $('#id_applicant_name').val()
            let surname_ = $('#id_applicant_surname').val()
            let phone_ = $('#id_phone').val()
            let subjects_ = $('input[type=checkbox]')
            let checkedValue = '';
            for (let i = 0, n = subjects_.length; i < n; i++) {
                if (subjects_[i].checked) {
                    checkedValue += subjects_[i].value;
                }
            }
            console.log(checkedValue)
            $.ajax({
                url: `/api/create-application`,
                type: "POST",
                data: JSON.stringify({
                    email: email_,
                    name: name_,
                    surname: surname_,
                    phone: phone_,
                    subjects: checkedValue
                }),
                success: function (data) {
                    if (data.error) {
                        $('#content').prepend(`<div class="alert alert-warning alert-dismissible fade show" role="alert"  id="${data.id}">
  <strong>${data.error}</strong>
  <button type="button" class="btn-close pb-2" data-bs-dismiss="alert" aria-label="Close"></button>
</div>`)
                        setInterval(function () {
                            $(`#${data.id}`).remove()
                        }, 5000);
                        console.log(`${data.error}`)
                        {#alert(`${data.success}`)#}
                        } else if (data.success) {
                        {#history.go(0);#}
                        $('.forms-sample')[0].reset();
                        $('#content').append(`<div class="alert alert-success alert-dismissible fade show" role="alert"  id="success_application">
  <strong>Заявка оставлена</strong>
  <button type="button" class="btn-close pb-2" data-bs-dismiss="alert" aria-label="Close"></button>
</div>`);


                    }
                },
                error: function (data) {
                    console.log('error')
                    alert('Ошибка')
                }
            });
        })
    </script>


{% endblock %}
{% block js %}
    <script src="{% static 'js/phone-mask.js' %}"></script>
{% endblock %}